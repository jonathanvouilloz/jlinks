---
// Disable prerendering for SSR dynamic routes
export const prerender = false;

import ListLayout from '../layouts/ListLayout.astro';
import CardsLayout from '../layouts/CardsLayout.astro';
import GridLayout from '../layouts/GridLayout.astro';
import PremiumLayout from '../layouts/PremiumLayout.astro';

// SSR mode - get slug from URL params (no getStaticPaths needed)
const { slug } = Astro.params;

// Get API URL from environment
const API_URL = import.meta.env.API_URL;
if (!API_URL && import.meta.env.PROD) {
  throw new Error(
    'API_URL environment variable is required for production builds. ' +
      'Please set it in your Vercel project settings.'
  );
}
const apiUrl = API_URL || 'http://localhost:5173/api';

// Fetch client data on every request
let client = null;
let links: any[] = [];

try {
  const response = await fetch(`${apiUrl}/public/clients/${slug}`);

  if (response.ok) {
    const data = await response.json();
    client = data.client;
    links = data.links;
  }
} catch (error) {
  console.error(`Error fetching client ${slug}:`, error);
}

// Return proper 404 response for SSR
if (!client) {
  return Astro.rewrite('/404');
}

// Set cache headers for CDN (60s cache, 5min stale-while-revalidate)
Astro.response.headers.set(
  'Cache-Control',
  'public, s-maxage=60, stale-while-revalidate=300'
);

// Choose layout based on client settings
const layouts = {
  list: ListLayout,
  cards: CardsLayout,
  grid: GridLayout,
  premium: PremiumLayout,
} as const;

type LayoutType = keyof typeof layouts;
const Layout = layouts[client.layout_type as LayoutType] || ListLayout;
---

<Layout client={client} links={links} />
