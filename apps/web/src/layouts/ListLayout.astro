---
import BaseLayout from './BaseLayout.astro';
import ProfileHeader from '../components/ProfileHeader.astro';
import LinkButton from '../components/LinkButton.astro';
import VCardButton from '../components/VCardButton.astro';
import Footer from '../components/Footer.astro';

interface Props {
  client: any;
  links: any[];
}

const { client, links } = Astro.props;

// Calculate text color based on background luminance
function getTextColorForBackground(bgColor: string, bgType: string): string {
  // Default to light text for gradients/images
  if (bgType !== 'solid' || !bgColor || !bgColor.startsWith('#')) {
    return '#ffffff';
  }

  const hex = bgColor.replace('#', '');
  const r = parseInt(hex.substr(0, 2), 16);
  const g = parseInt(hex.substr(2, 2), 16);
  const b = parseInt(hex.substr(4, 2), 16);

  // Calculate relative luminance (WCAG formula)
  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;

  return luminance > 0.5 ? '#0f172a' : '#ffffff';
}

const textColor = getTextColorForBackground(client.background_value, client.background_type);
---

<BaseLayout
  title={client.meta_title || client.name}
  description={client.meta_description || client.bio}
  fontPreset={client.font_preset}
  fontTitle={client.font_title}
  fontText={client.font_text}
  backgroundColor={client.background_value}
  textColor={textColor}
>
  <main class="container">
    <ProfileHeader
      name={client.name}
      bio={client.bio}
      imageUrl={client.profile_image_url}
      logoUrl={client.logo_url}
    />

    <div class="links-list">
      {
        links.map((link) => {
          // For 'theme' preset, use primary_color directly (ignore preset.bgColor)
          const useTheme = link.social_preset === 'theme';
          return (
            <LinkButton
              title={link.title}
              url={link.url}
              icon={link.icon}
              socialPreset={useTheme ? null : link.social_preset}
              bgColor={useTheme ? client.primary_color : (link.custom_bg_color || client.primary_color)}
              textColor={link.custom_text_color || '#FFFFFF'}
            />
          );
        })
      }
    </div>

    {client.vcard_enabled && <VCardButton slug={client.slug} />}

    <Footer showBranding={client.plan !== 'pro'} />
  </main>
</BaseLayout>
