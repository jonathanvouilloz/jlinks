---
import BaseLayout from './BaseLayout.astro';
import ProfileHeader from '../components/ProfileHeader.astro';
import Icon from '../components/Icon.astro';
import VCardButton from '../components/VCardButton.astro';
import Footer from '../components/Footer.astro';
import { SOCIAL_PRESETS } from '@noko/shared';
import type { SocialPresetKey, ButtonStyle } from '@noko/shared';

interface Props {
  client: any;
  links: any[];
}

const { client, links } = Astro.props;

// Calculate text color based on background luminance
function getTextColorForBackground(bgColor: string, bgType: string): string {
  if (bgType !== 'solid' || !bgColor || !bgColor.startsWith('#')) {
    return '#ffffff';
  }

  const hex = bgColor.replace('#', '');
  const r = parseInt(hex.slice(0, 2), 16);
  const g = parseInt(hex.slice(2, 4), 16);
  const b = parseInt(hex.slice(4, 6), 16);

  const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
  return luminance > 0.5 ? '#0f172a' : '#ffffff';
}

const textColor = getTextColorForBackground(client.background_value, client.background_type);

// Convert hex to rgba with opacity
function hexToRgba(hex: string, alpha: number): string {
  if (!hex || !hex.startsWith('#')) return hex;
  const r = parseInt(hex.slice(1, 3), 16);
  const g = parseInt(hex.slice(3, 5), 16);
  const b = parseInt(hex.slice(5, 7), 16);
  return `rgba(${r}, ${g}, ${b}, ${alpha / 100})`;
}

const buttonOpacity = client.button_opacity ?? 100;
const buttonStyle = client.button_style || 'rounded';

// Get border-radius based on button style
function getButtonRadius(style: string): string {
  switch (style) {
    case 'pill': return '24px';
    case 'square': return '4px';
    case 'soft': return '16px';
    case 'outline':
    case 'outline-icon': return '8px';
    case 'rounded':
    default: return '8px';
  }
}

const isOutline = buttonStyle === 'outline' || buttonStyle === 'outline-icon';
const showPresetIcon = buttonStyle !== 'outline'; // outline = sans icône, outline-icon = avec icône
const outlineColor = client.primary_color || '#FF6B5B'; // Couleur uniforme pour les styles outline
const cardRadius = getButtonRadius(buttonStyle);

// Transform background based on type
const bgValue = client.background_value || '#ffffff';
const isImageBg = client.background_type === 'image';

// For image backgrounds: apply image to both mobile (backgroundColor) and desktop (outerBackgroundColor)
// For solid/gradient: card gets the background, outer uses configured color
const backgroundColor = isImageBg
  ? `url('${bgValue}') center/cover no-repeat`
  : bgValue;
const containerBackgroundDesktop = isImageBg ? 'transparent' : bgValue;
const outerBackgroundColor = isImageBg
  ? `url('${bgValue}') center/cover no-repeat`
  : client.outer_background_color;
---

<BaseLayout
  title={client.meta_title || client.name}
  description={client.meta_description || client.bio}
  fontPreset={client.font_preset}
  fontTitle={client.font_title}
  fontText={client.font_text}
  backgroundColor={backgroundColor}
  outerBackgroundColor={outerBackgroundColor}
  containerBackgroundDesktop={containerBackgroundDesktop}
  textColor={textColor}
>
  <main class="container">
    <div class="main-content">
      <ProfileHeader
        name={client.name}
        bio={client.bio}
        imageUrl={client.profile_image_url}
        logoUrl={client.logo_url}
        imageSize={client.profile_image_size}
        imageShape={client.profile_image_shape}
      />

      <div class="links-cards">
        {
          links.map((link) => {
            // For 'theme' preset, use primary_color directly (ignore preset.bgColor)
            const useTheme = link.social_preset === 'theme';
            const preset = link.social_preset && !useTheme
              ? SOCIAL_PRESETS[link.social_preset as SocialPresetKey]
              : null;
            const bgColor = useTheme ? client.primary_color : (preset?.bgColor || link.custom_bg_color || client.primary_color);
            const bgStyle = buttonOpacity < 100 && bgColor.startsWith('#') ? hexToRgba(bgColor, buttonOpacity) : bgColor;
            const textColor = preset?.textColor || link.custom_text_color || '#FFFFFF';
            const iconName = link.icon || preset?.icon || 'link';
            const iconSource = preset?.iconSource || (useTheme ? SOCIAL_PRESETS.theme.iconSource : 'lucide');

            const cardStyle = isOutline
              ? `background: transparent; border: 2px solid ${outlineColor}; color: ${outlineColor}; border-radius: ${cardRadius};`
              : `background: ${bgStyle}; color: ${textColor}; border-radius: ${cardRadius};`;

            return (
              <a
                href={link.url}
                class="link-card"
                style={cardStyle}
                target="_blank"
                rel="noopener noreferrer"
              >
                {link.thumbnail_url ? (
                  <img
                    src={link.thumbnail_url}
                    alt={`Image pour ${link.title}`}
                    class="link-card-thumbnail"
                    loading="lazy"
                  />
                ) : showPresetIcon && (
                  <span class="link-card-icon">
                    <Icon name={iconName} size={32} source={iconSource} />
                  </span>
                )}
                <span class="link-card-title">{link.title}</span>
                {link.description && (
                  <span class="link-card-description">{link.description}</span>
                )}
              </a>
            );
          })
        }
      </div>

      {client.vcard_enabled && <VCardButton slug={client.slug} />}
    </div>

    <Footer showBranding={client.plan !== 'pro'} />
  </main>
</BaseLayout>
